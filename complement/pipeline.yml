# WARNING: do not enable builds of third-party PRs on this pipeline. The pipeline is configured to
# give access to the Docker socket to the Complement test binaries, so a malicious fork of
# Complement could start a Docker container which extracts the Buildkite agent token and hence
# compromises this and other Buildkite agents.

steps:
  # Build and lint
  - command:
      - echo "deb http://deb.debian.org/debian buster-backports main" > /etc/apt/sources.list.d/complement.list
      - apt-get update && apt-get install -y libolm3 libolm-dev/buster-backports
      - ./build/scripts/build-and-lint.sh
    label: "\U0001F9F9 Lint / :go: 1.15"
    agents:
      # Use a larger instance as linting takes a lot of memory
      queue: "xlarge"
    plugins:
      - docker#v3.7.0:
          image: "golang:1.15"
          mount-buildkite-agent: false
    retry:
      automatic:
        - exit_status: 128
          limit: 3

  - command:
      # Build a docker image from the same named branch or the latest version of
      # Synapse, so download it here.
      - "mkdir -p /synapse"
      - "(wget -O - https://github.com/matrix-org/synapse/archive/$BUILDKITE_BRANCH.tar.gz || wget -O - https://github.com/matrix-org/synapse/archive/develop.tar.gz) | tar -xz --strip-components=1 -C /synapse"
      - "docker build -t matrixdotorg/synapse:latest -f /synapse/docker/Dockerfile /synapse"
      # Build a second docker image on top of the above image. This one sets up Synapse with a generated config file,
      # signing and SSL keys so Synapse can run and federate
      - docker build -t complement-synapse -f dockerfiles/Synapse.Dockerfile dockerfiles/
      # Run the tests!
      - COMPLEMENT_BASE_IMAGE=complement-synapse go test -v -tags "synapse_blacklist,msc2403,msc2946,msc3083" ./tests
    label: "\U0001F9EA Complement / Synapse Monolith / :go: 1.15"
    agents:
      queue: "medium"
    plugins:
      - docker#v3.7.0:
          # The dockerfile for this image is at https://github.com/matrix-org/complement/blob/HEAD/dockerfiles/ComplementCIBuildkite.Dockerfile.
          image: "matrixdotorg/complement:latest"
          mount-buildkite-agent: false
          # Complement needs to know if it is running under CI
          environment:
           - "CI=true"
          publish: [ "8448:8448" ]
          # Complement uses Docker so pass through the docker socket. This means Complement shares
          # the host's Docker.
          volumes:
            - "/var/run/docker.sock:/var/run/docker.sock"
    retry:
      automatic:
        - exit_status: 128
          limit: 3

  - command:
      # Build the Dendrite for Complement docker image, which is located at:
      # https://github.com/matrix-org/complement/blob/HEAD/dockerfiles/Dendrite.Dockerfile.
      - docker build -t complement-dendrite -f dockerfiles/Dendrite.Dockerfile .
      # Run the tests!
      - COMPLEMENT_BASE_IMAGE=complement-dendrite go test -v -tags "dendrite_blacklist,msc2836" ./tests
    label: "\U0001F9EA Complement / Dendrite Monolith / :go: 1.15"
    agents:
      queue: "medium"
    plugins:
      - docker#v3.7.0:
          # The dockerfile for this image is at https://github.com/matrix-org/complement/blob/HEAD/dockerfiles/ComplementCIBuildkite.Dockerfile.
          image: "matrixdotorg/complement:latest"
          mount-buildkite-agent: false
          # Complement needs to know if it is running under CI
          environment:
           - "CI=true"
          publish: [ "8448:8448" ]
          # Complement uses Docker so pass through the docker socket. This means Complement shares
          # the host's Docker.
          volumes:
            - "/var/run/docker.sock:/var/run/docker.sock"
    retry:
      automatic:
        - exit_status: 128
          limit: 3
